#!/usr/bin/env node
"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function l(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,l)}c((o=o.apply(e,t||[])).next())}))};const{createServer:createServer,build:build,preview:preview}=require("vite"),puppeteer=require("puppeteer"),portfinder=require("portfinder"),nodeFetch=require("node-fetch"),replaceall=require("replaceall"),terminator=require("http-terminator"),exit=()=>{process.exit(0)},globals={port:0,notfound:Math.random().toString(36).slice(2),basename:""},init=()=>__awaiter(void 0,void 0,void 0,(function*(){const e=yield createServer({configFile:`${process.cwd()}/vite.config.ts`,root:process.cwd(),mode:"COMPILE"}),t=yield portfinder.getPortPromise();yield e.listen(t),globals.port=t;const i=yield(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();yield i.goto(`http://localhost:${t}`);const o=()=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,2e3)));const t=yield i.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35")));let n=yield i.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35b")));null!=t&&null!=n?(yield i.close(),yield e.close(),n.length>0&&(n.startsWith("/")&&n.replace("/",""),n.endsWith("/")||(n+="/")),globals.basename=n,yield runner(JSON.parse(null!=t?t:"{}")),process.exit(0)):yield o()}));yield o()})),runner=e=>__awaiter(void 0,void 0,void 0,(function*(){yield build({root:process.cwd(),configFile:`${process.cwd()}/vite.config.ts`});const t={};for(const i in e){const o=e[i],n=void 0!==o.config&&"compile"in o.config?o.config:{compile:!1};if(n.compile)if("dynamic"===n.type){for(let e=n.params.length-1;e>-1;e--)n.params[e].includes("/")&&n.params.pop();if(n.params.length<1)continue}else"wildcard"===n.type&&(n.paths=[`/${globals.notfound}`]);t[o.path]=n}const i=[],o={};for(const e in t){let n=`${e}`;const r=t[e];let s=!1;n.endsWith("//")&&(s=!0,n=n.substring(0,n.length-2)),n.endsWith("/")&&(n=n.substring(0,n.length-1));const l=n.split("/");s&&l.push("/"),o[l.join("/")]=r;const c=l.map(((e,t)=>t===l.length-1?{path:e,config:r}:{path:e,config:void 0}));i.push(c)}const n=i.shift();for(const e of i)for(;void 0!==e.find((e=>void 0===e.config));){let t="",i=0;for(const o of e){if(void 0!==o.config)break;t+=`${o.path}/`,i++}t=t.substring(0,t.length-1),e[i-1].config=o[t]}i.unshift(n);const r=clean(i),s=buildPaths(r);yield prerender(s)})),clean=e=>{e=(e=e.filter((t=>{const i=t[t.length-1];if("/"===i.path){let o="";for(const{path:e}of t)o+=`${e}/`;for(o=o.substring(0,o.length-1);o.endsWith("/");)o=o.substring(0,o.lastIndexOf("/"));const n=e.find((e=>{let t="";for(const{path:i}of e)t+=`${i}/`;for(t=t.substring(0,t.length-1);t.endsWith("/");)t=t.substring(0,t.lastIndexOf("/"));return o===t}));return void 0!==n&&(n[n.length-1].config=i.config),!1}return!0}))).filter((e=>{var t;return!(!1===(null===(t=e[e.length-1].config)||void 0===t?void 0:t.compile)||void 0!==e.filter((e=>e.path.includes(":"))).find((e=>{var t;return!((null===(t=e.config)||void 0===t?void 0:t.compile)&&"dynamic"===e.config.type&&e.config.params.length>0)}))||void 0!==e.filter((e=>e.path.includes("*"))).find((e=>{var t;return!((null===(t=e.config)||void 0===t?void 0:t.compile)&&"wildcard"===e.config.type&&e.config.paths.length>0)})))}));for(const t of e)for(const e of t)if(e.config&&e.config.compile&&"dynamic"===e.config.type){const t=[""];e.config.params=e.config.params.filter((e=>!t.includes(e)&&(t.push(e),!0)))}else if(e.config&&e.config.compile&&"wildcard"===e.config.type){const t=[""];e.config.paths=e.config.paths.filter((e=>!t.includes(e)&&(t.push(e),!0)))}return e},buildPaths=e=>{let t=[];for(const i of e){if(0!==i.length){const e=buildCascadingCompilierConfigSegment(i);for(const i of e.paths)void 0!==e.child?t.push(...buildPathTree(i,e.child)):t.push(i)}const e=[];t=t.filter((t=>!e.includes(t)&&(e.push(t),!0))),t=t.map((e=>replaceall("//","/",e+="/")))}return t=t.map((e=>`http://${e}`.replace(`localhost:${globals.port}/`,`localhost:${globals.port}/${globals.basename}`))),t},buildCascadingCompilierConfigSegment=e=>{const{path:t,config:i}=e.shift(),o=[];return"dynamic"===i.type?o.push(...i.params):"wildcard"===i.type?o.push(...i.paths):"$"===t?o.push(`localhost:${globals.port}/`):o.push(t),0===e.length?{paths:o}:{paths:o,child:buildCascadingCompilierConfigSegment(e)}},buildPathTree=(e,t)=>{const i=[],o=t.child;if(void 0!==o)for(const n of t.paths){let t=buildPathTree(n,o);t=t.map((t=>`${e}/${t}`)),i.push(...t)}else for(const o of t.paths)i.push(`${e}/${o}`);return i},prerender=e=>__awaiter(void 0,void 0,void 0,(function*(){const t=yield preview({configFile:`${process.cwd()}/vite.config.ts`,mode:"COMPILE",preview:{port:globals.port,host:"localhost",open:!1}}),i=terminator.createHttpTerminator({server:t.httpServer});(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();console.log(e),yield i.terminate()})),sleep=e=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((t=>setTimeout(t,e)))}));__awaiter(void 0,void 0,void 0,(function*(){const e=yield createServer({configFile:`${process.cwd()}/vite.config.ts`,root:process.cwd(),mode:"COMPILE"}),t=yield portfinder.getPortPromise();yield e.listen(t),globals.port=t;const i=yield(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();yield i.goto(`http://localhost:${t}`);const o=()=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,2e3)));const t=yield i.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35")));let n=yield i.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35b")));null!=t&&null!=n?(yield i.close(),yield e.close(),n.length>0&&(n.startsWith("/")&&n.replace("/",""),n.endsWith("/")||(n+="/")),globals.basename=n,yield runner(JSON.parse(null!=t?t:"{}")),process.exit(0)):yield o()}));yield o()})).catch(console.error);
