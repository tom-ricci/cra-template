#!/usr/bin/env node
"use strict";var __awaiter=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))((function(l,s){function n(e){try{a(i.next(e))}catch(e){s(e)}}function r(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?l(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(n,r)}a((i=i.apply(e,t||[])).next())}))};const{createServer:createServer,build:build,preview:preview}=require("vite"),puppeteer=require("puppeteer"),portfinder=require("portfinder"),replaceall=require("replaceall"),terminator=require("http-terminator"),colors=require("ansi-colors"),fs=require("fs-extra"),exit=()=>{process.exit(0)},globals={port:0,notfound:"jtbuksxfmarnecqwldhigvpyo",basename:""},utils={logProgress:e=>{utils.logSafely(`${colors.bold.blue("âž¤")} ${colors.bold(e)}`)},logSafely:e=>{console.log(`${e}[0m`)},logSuccess:e=>{utils.logSafely(`${colors.bold.blue("âœ“")} ${colors.bold(e)}`)}},init=()=>__awaiter(void 0,void 0,void 0,(function*(){utils.logProgress("Building app..."),utils.logProgress("Finding windows...");const e=yield createServer({configFile:`${process.cwd()}/vite.config.ts`,root:process.cwd(),mode:"COMPILE"}),t=yield portfinder.getPortPromise();yield e.listen(t),globals.port=t;const o=yield(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();yield o.goto(`http://localhost:${t}`);const i=()=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,2e3)));const t=yield o.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35")));let l=yield o.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35b")));null!=t&&null!=l?(yield o.close(),yield e.close(),l.length>0&&(l.startsWith("/")&&l.replace("/",""),l.endsWith("/")||(l+="/")),globals.basename=l,yield runner(JSON.parse(null!=t?t:"{}")),process.exit(0)):yield i()}));yield i()})),runner=e=>__awaiter(void 0,void 0,void 0,(function*(){utils.logProgress("Bundling app with Vite..."),yield build({root:process.cwd(),configFile:`${process.cwd()}/vite.config.ts`}),utils.logSuccess("App bundled!"),utils.logProgress("Resolving compilier configuration...");const t={};for(const o in e){const i=e[o],l=void 0!==i.config&&"compile"in i.config?i.config:{compile:!1};if(l.compile)if("dynamic"===l.type){for(let e=l.params.length-1;e>-1;e--)l.params[e].includes("/")&&l.params.pop();if(l.params.length<1)continue}else"wildcard"===l.type&&(l.paths=[`/${globals.notfound}`]);t[i.path]=l}const o=[],i={};for(const e in t){let l=`${e}`;const s=t[e];let n=!1;l.endsWith("//")&&(n=!0,l=l.substring(0,l.length-2)),l.endsWith("/")&&(l=l.substring(0,l.length-1));const r=l.split("/");n&&r.push("/"),i[r.join("/")]=s;const a=r.map(((e,t)=>t===r.length-1?{path:e,config:s}:{path:e,config:void 0}));o.push(a)}const l=o.shift();for(const e of o)for(;void 0!==e.find((e=>void 0===e.config));){let t="",o=0;for(const i of e){if(void 0!==i.config)break;t+=`${i.path}/`,o++}t=t.substring(0,t.length-1),e[o-1].config=i[t]}o.unshift(l);const s=clean(o),n=buildPaths(s),r=yield prerender(n);storeFiles(r)})),clean=e=>{e=(e=e.filter((t=>{const o=t[t.length-1];if("/"===o.path){let i="";for(const{path:e}of t)i+=`${e}/`;for(i=i.substring(0,i.length-1);i.endsWith("/");)i=i.substring(0,i.lastIndexOf("/"));const l=e.find((e=>{let t="";for(const{path:o}of e)t+=`${o}/`;for(t=t.substring(0,t.length-1);t.endsWith("/");)t=t.substring(0,t.lastIndexOf("/"));return i===t}));return void 0!==l&&(l[l.length-1].config=o.config),!1}return!0}))).filter((e=>{var t;return!(!1===(null===(t=e[e.length-1].config)||void 0===t?void 0:t.compile)||void 0!==e.filter((e=>e.path.includes(":"))).find((e=>{var t;return!((null===(t=e.config)||void 0===t?void 0:t.compile)&&"dynamic"===e.config.type&&e.config.params.length>0)}))||void 0!==e.filter((e=>e.path.includes("*"))).find((e=>{var t;return!((null===(t=e.config)||void 0===t?void 0:t.compile)&&"wildcard"===e.config.type&&e.config.paths.length>0)})))}));for(const t of e)for(const e of t)if(e.config&&e.config.compile&&"dynamic"===e.config.type){const t=[""];e.config.params=e.config.params.filter((e=>!t.includes(e)&&(t.push(e),!0)))}else if(e.config&&e.config.compile&&"wildcard"===e.config.type){const t=[""];e.config.paths=e.config.paths.filter((e=>!t.includes(e)&&(t.push(e),!0)))}return e},buildPaths=e=>{let t=[];for(const o of e){if(0!==o.length){const e=buildCascadingCompilierConfigSegment(o);for(const o of e.paths)void 0!==e.child?t.push(...buildPathTree(o,e.child)):t.push(o)}const e=[];t=t.filter((t=>!e.includes(t)&&(e.push(t),!0))),t=t.map((e=>replaceall("//","/",e+="/")))}return t=t.map((e=>`http://${e}`.replace(`localhost:${globals.port}/`,`localhost:${globals.port}/${globals.basename}`))),t=t.map((e=>e.endsWith("/")?e.substring(0,e.length-1):e)),t=t.filter((e=>!e.includes(globals.notfound))),t},buildCascadingCompilierConfigSegment=e=>{const{path:t,config:o}=e.shift(),i=[];return"dynamic"===o.type?i.push(...o.params):"wildcard"===o.type?i.push(...o.paths):"$"===t?i.push(`localhost:${globals.port}/`):i.push(t),0===e.length?{paths:i}:{paths:i,child:buildCascadingCompilierConfigSegment(e)}},buildPathTree=(e,t)=>{const o=[],i=t.child;if(void 0!==i)for(const l of t.paths){let t=buildPathTree(l,i);t=t.map((t=>`${e}/${t}`)),o.push(...t)}else for(const i of t.paths)o.push(`${e}/${i}`);return o},prerender=e=>__awaiter(void 0,void 0,void 0,(function*(){utils.logProgress("Prerendering windows...");const t=yield preview({configFile:`${process.cwd()}/vite.config.ts`,preview:{port:globals.port,host:"localhost",open:!1}}),o=terminator.createHttpTerminator({server:t.httpServer}),i=[],l=yield puppeteer.launch({args:["--no-sandbox"]});for(const t of e){utils.logProgress(`Prerendering ${t}...`);const e=yield l.newPage();yield e.evaluateOnNewDocument((()=>{sessionStorage.setItem("jtbuksxfmarnecqwldhigvpyo","yes")}));let o=new URL(t).pathname;o=o.endsWith("/")?o:`${o}/`,o=o.startsWith("./")?o.replace("./","/"):o,o=o.startsWith("/")?o:`/${o}`,yield e.goto(t,{waitUntil:"networkidle0"}),yield e.waitForSelector(`meta[data-jtbuksxfmarnecqwldhigvpyo-mn="${o}"][data-jtbuksxfmarnecqwldhigvpyo-ms="true"]`),yield e.waitForSelector(`#root[data-jtbuksxfmarnecqwldhigvpyo-pn="${o}"]`);const s=yield e.content();i.push({path:o,html:s}),utils.logSuccess(`${t} successfully prerendered!`)}yield o.terminate();for(const e of i)e.html=replaceall(`<meta data-jtbuksxfmarnecqwldhigvpyo-mn="${e.path}" data-jtbuksxfmarnecqwldhigvpyo-ms="true">`,"",e.html),e.html=replaceall(`data-jtbuksxfmarnecqwldhigvpyo-pn="${e.path}"`,"",e.html);return i})),storeFiles=e=>{utils.logProgress("Packaging build...");const t=JSON.parse(fs.readFileSync("./package.json"));let o=!1,i=!1,l=!1;for(const s of e)"all"===t.compile.index?storePage(s.path,s.html,"index"):"root"===t.compile.index&&(o=!0),"all"===t.compile[404]?storePage(s.path,s.html,"404"):"root"===t.compile[404]&&(i=!0),"all"===t.compile[200]?storePage(s.path,s.html,"200"):"root"===t.compile[200]&&(l=!0);o&&storeRootPage(e,"index"),i&&storeRootPage(e,"404"),l&&storeRootPage(e,"200");let s=`${globals.basename}`;s=s.startsWith("/")?s:`/${s}`,s=s.endsWith("/")?s:`${s}/`,fs.rmSync("./dist/index.html"),fs.copySync("./dist",`./build${s}`,{overwrite:!0}),fs.removeSync("./dist"),utils.logSuccess("Build complete!")},storePage=(e,t,o)=>{fs.mkdirSync(`./build${e}`,{recursive:!0}),fs.writeFileSync(`./build${e}/${o}.html`,t)},storeRootPage=(e,t)=>{let o=0;for(let t=0;t<e.length;t++)e[t].path.length<=e[o].path.length&&(o=t);storePage(e[o].path,e[o].html,t)};__awaiter(void 0,void 0,void 0,(function*(){utils.logProgress("Building app..."),utils.logProgress("Finding windows...");const e=yield createServer({configFile:`${process.cwd()}/vite.config.ts`,root:process.cwd(),mode:"COMPILE"}),t=yield portfinder.getPortPromise();yield e.listen(t),globals.port=t;const o=yield(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();yield o.goto(`http://localhost:${t}`);const i=()=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,2e3)));const t=yield o.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35")));let l=yield o.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35b")));null!=t&&null!=l?(yield o.close(),yield e.close(),l.length>0&&(l.startsWith("/")&&l.replace("/",""),l.endsWith("/")||(l+="/")),globals.basename=l,yield runner(JSON.parse(null!=t?t:"{}")),process.exit(0)):yield i()}));yield i()})).catch(console.error);
