#!/usr/bin/env node
"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,o){return new(t||(t=Promise))((function(n,s){function r(e){try{l(o.next(e))}catch(e){s(e)}}function c(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var i;e.done?n(e.value):(i=e.value,i instanceof t?i:new t((function(e){e(i)}))).then(r,c)}l((o=o.apply(e,i||[])).next())}))};const{createServer:createServer,build:build}=require("vite"),puppeteer=require("puppeteer"),portfinder=require("portfinder"),{exec:exec}=require("child_process"),nodeFetch=require("node-fetch"),merge=require("lodash.merge"),util=require("util"),exit=()=>{process.exit(0)},init=()=>__awaiter(void 0,void 0,void 0,(function*(){const e=yield createServer({configFile:`${process.cwd()}/vite.config.ts`,root:process.cwd(),mode:"COMPILE"}),i=yield portfinder.getPortPromise();yield e.listen(i);const t=yield(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();yield t.goto(`http://localhost:${i}`);const o=()=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,2e3)));const i=yield t.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35")));null!=i?(yield t.close(),yield e.close(),yield runner(JSON.parse(null!=i?i:"{}")),process.exit(0)):yield o()}));yield o()})),runner=e=>__awaiter(void 0,void 0,void 0,(function*(){yield build({root:process.cwd(),configFile:`${process.cwd()}/vite.config.ts`});const i=yield portfinder.getPortPromise(),t=exec(`npx --yes serve -s -p ${i} -n`,{cwd:`${process.cwd()}/dist/`}),o=()=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,2e3)));const t=yield nodeFetch(`http://localhost:${i}`);if(t.ok&&200===t.status){yield(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();const i={};for(const t in e){const o=e[t],n=void 0!==o.config&&"compile"in o.config?o.config:{compile:!1};if(n.compile)if("dynamic"===n.type){for(let e=n.params.length;e>-1;e--)n.params[e].includes("/")&&n.params.pop();if(n.params.length<1)continue}else"wildcard"===n.type&&(n.paths=n.paths.map((e=>(e.startsWith("./")&&(e=e.substring(1)),e.startsWith("/")||(e=`/${e}`),e))));i[o.path]=n}const t=[];for(const e in i){let o=`${e}`;const n=i[e];let s=!1;o.endsWith("//")&&(s=!0,o=o.substring(0,o.length-2)),o.endsWith("/")&&(o=o.substring(0,o.length-1));const r=o.split("/");s&&r.push("/"),t.push(makeTreeSegment(r,n))}console.log(util.inspect(t,!1,null,!0));const o=t.shift();for(const e of t);console.log(o)}else yield o()}));yield o(),t.kill("SIGKILL")})),makeTreeSegment=(e,i)=>{var t;const o={path:e[0]};if(o.children=null!==(t=o.children)&&void 0!==t?t:[],1===e.length)o.config=i;else{e.shift();const t=makeTreeSegment(e,i);o.children.push(t)}return o};__awaiter(void 0,void 0,void 0,(function*(){const e=yield createServer({configFile:`${process.cwd()}/vite.config.ts`,root:process.cwd(),mode:"COMPILE"}),i=yield portfinder.getPortPromise();yield e.listen(i);const t=yield(yield puppeteer.launch({args:["--no-sandbox"]})).newPage();yield t.goto(`http://localhost:${i}`);const o=()=>__awaiter(void 0,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,2e3)));const i=yield t.evaluate((()=>sessionStorage.getItem("8769b6cf-ac3f-4d8c-b6b7-cd72d7910f35")));null!=i?(yield t.close(),yield e.close(),yield runner(JSON.parse(null!=i?i:"{}")),process.exit(0)):yield o()}));yield o()})).catch(console.error);
